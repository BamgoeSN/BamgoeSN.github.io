---
layout: post
title: "[BOJ 9519] 졸려 - 시뮬레이션 풀이가 통과되는 이유"
date: 2024-01-18 15:03:00 +0900
categories: ["BOJ"]
tags: ["Math", "Number Theory"]
katex: true
description: "셔플의 주기가 O(n)인 이유에 대한 증명입니다."
---

### 참고 자료
- [OEIS A003558](https://oeis.org/A003558)
- Paul Lévy, [Sur quelques classes de permutations](http://www.numdam.org/item/?id=CM_1951__8__1_0), *Compositio Mathematica*, 8 (1951), 1-48.

# 문제
[BOJ 9519 졸려](https://www.acmicpc.net/problem/9519)

# 풀이
문제에서 주어진 셔플을 직접 입력된 문자열에 반복 적용하여 주기가 얼마인지 확인하고, 셔플 횟수에 따른 문자열의 형태를 그 주기까지만 저장해두면 답을 구할 수 있다.

이 풀이는 셔플을 반복 적용했을 때 제자리로 돌아오기까지 걸리는 주기를 $T$라 하고, 입력된 문자열의 길이를 $N$이라 하면 시간복잡도는 $\tilde{O} (NT)$이다. 즉 $T$가 충분히 작아야 통과되는 풀이인데, 실제로 그 주기가 짧은지에 대한 보장이 없는데도 해당 풀이를 제출하면 정답을 받는다.

길이 $N$인 순열을 반복 적용했을 때의 주기는 반드시 짧으라는 보장이 없다. 그 주기는 순열을 사이클로 분할했을 때 나오는 사이클 주기의 최소공배수이므로, $N$에 대해 가능한 최대 주기는 꽤 빠르게 증가한다. 예를 들어 길이가 10인 순열 `[1, 0, 3, 4, 2, 6, 7, 8, 9, 5]`는 반복 적용 시 그 주기가 30이다. 길이가 17이면서 주기가 210인 순열도 만들 수 있다. 따라서 이 문제에서 주어진 셔플의 주기가 짧은 것은 일반적인 성질이 아니다.

그러면 왜 이 셔플은 주기가 짧을까? 문제에서 주어진 셔플의 주기가 $O(N)$이라는 사실을 증명할 수 있다.

## 셔플의 주기
문제에서 주어진 셔플은 milk shuffle이라고 부르는 것이다. 이 셔플을 수식으로 표현해보자.

$[0, n)$의 정수가 순서대로 있는 수열에 셔플을 한 번 수행했을 때, $x$번 인덱스에 있던 수가 이동하는 인덱스를 $Px$라고 하자. 그러면 우리는 모든 $x \in [0, n)$에 대해 $P^\sigma x = x$인 $\sigma$를 셔플의 주기라고 할 수 있다. 가장 작은 $\sigma$의 값에 대한 일반적인 식을 구하는 건 어렵겠지만, 최소한 가능한 $\sigma$의 값 중 하나는 $O(n)$이라는 사실만 증명해보자.

$Px$는 다음과 같이 쓸 수 있다.

$$
Px = \begin{cases}
2x &\left( x \leq \frac{n-1}{2} \right) \\\\
-2x + 2n-1 &\left( x > \frac{n-1}{2} \right)
\end{cases}
$$

이렇게 보니까 이걸 여러 차례 적용하려고 하니 너무 어려워 보인다. 따라서, $x$에 대해 $Px$를 조금 다른 과정으로 구해보자. 위 식은 다음과 같이 계산하는 것과 동일한 결과를 낸다.

1. $2x \bmod (2n-1)$을 구한다.
2. 그 값이 $n$ 이상이면 $2n-1$을 뺀다.
3. 그 값에 절댓값을 취하면 $Px$가 나온다.

예를 들어 $n = 5$라면 초기에 `[0, 1, 2, 3, 4]`이던 배열은 셔플 후 `[0, 4, 1, 3, 2]`가 된다. 위 절차를 모든 수에 대해 적용해보면 올바른 셔플 결과가 나옴을 알 수 있다.

모듈로 연산의 성질을 고려하여 이와 유사한 방법으로 $P^{\sigma} x$를 구하는 절차는 다음과 같다. 위 절차를 $\sigma$번 반복하는 것을 모듈러 연산의 특성을 활용해 단순화한 것이다.

1. $2^{\sigma} \bmod (2n-1)$을 구한다.
2. 그 값이 $n$ 이상이면 $2n-1$을 뺀다.
3. 그 값에 절댓값을 취하면 $Px$가 나온다.

이를 달리 해석하면 다음 식을 만족하는 $\sigma$는 *모든* $x$에 대해 $P^{\sigma} x = x$를 만족한다는 뜻이 된다.

$$
2^{\sigma} \equiv \pm 1 \mod (2n-1)
$$

이걸 만족하는 아무 $\sigma$나 구해보자. $2$와 $2n-1$은 서로소이므로 오일러 정리에 의해 $\sigma = \phi(2n-1)$은 위 식을 만족한다. 따라서, milk shuffle은 주기가 $\phi(2n-1)$ 이하로, $\phi(2n-1)$번 이하 셔플을 반복하다보면 문자열이 제자리로 돌아오게 된다.

$\phi(2n-1) \sim O(2n-1) \sim O(n)$이므로, 직접 시뮬레이션을 돌리는 풀이는 유효한 풀이이다.