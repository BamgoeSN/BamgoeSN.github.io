---
layout: post
title: "[BOJ 9212] 트라이앵글"
date: 2023-11-13 22:55:00 +0900
categories: ["BOJ"]
katex: true
description: " "
---

# 문제
[BOJ 9212 트라이앵글](https://www.acmicpc.net/problem/9212)

# 풀이
아래 문단에서 모든 벡터는 **3차원 벡터**입니다! 따라서 두 벡터의 외적은 평면벡터에서의 CCW와 달리 벡터입니다.

한 삼각형의 세 꼭짓점을 P, Q, R이라 하고, 다른 한 삼각형을 T라고 합시다. 우리는 삼각형 PQR이 삼각형 T와 얽혀 있는지 알고자 합니다.

## 판별 조건 설정
삼각형이 얽혀 있을 조건을 생각해봅시다. 삼각형 T가 포함되는 평면을 평면 a라고 합시다. 우선, 삼각형 PQR의 세 변 중 하나 이상이 평면 a 위에 있다면 두 삼각형은 분리가 가능합니다. 이는 문제의 조건에서 두 삼각형이 교차하는 경우가 없다고 했기 때문입니다. 이 경우를 제외하고 나면, 이제 우리는 삼각형 PQR의 세 변 중 그 어느 것도 평면 a 위에 있지 않다고 전제할 수 있습니다.

그런 전제가 있다면, 이제 삼각형 PQR과 삼각형 T가 얽혀 있을 조건은, 삼각형 PQR이 평면 a와 이루는 교점 중 오로지 하나가 삼각형 T 내부에 있어야 한다는 것입니다. 삼각형 T 내부에 있는 교점이 없다면 평면 a와 삼각형 PQR이 교차하지도 않으니 얽힐 가능성이 없고, 그러한 교점이 둘이라면 삼각형 PQR을 삼각형 T 밖으로 꺼낼 수 있습니다. 셋 이상일 수는 없습니다.

따라서 다음 두 가지를 판정/계산할 수 있어야 합니다.
- 주어진 선분이 주어진 평면 위에 있는가?
- 삼각형과 평면의 교점은 무엇이며, 그 교점은 평면 위의 삼각형 내부에 있는가?

## 평면의 선분 포함 여부 판정
어떤 선분이 평면 위에 있는지는, 그 선분 위의 점 하나가 평면 위에 있으면서 그 선분이 평면과 평행하면 됩니다. 하나씩 판정해봅시다.

### 평면의 점 포함 여부 판정
세 점 $\vec{a}$, $\vec{b}$, $\vec{c}$를 지나는 평면 위의 임의의 점은, $\vec{u} = \vec{b}-\vec{a}$와 $\vec{v} = \vec{c}-\vec{a}$에 대해 다음과 같이 쓸 수 있습니다. 단, 평면이 제대로 정의되게 하기 위해 이 세 점은 일직선 위에 있지 않음을 가정합시다.

$$ \vec{a} + s\vec{u} + t\vec{v} \qquad (s \in \mathbb{R},\ t \in \mathbb{R}) $$

어떤 점 $\vec{p}$가 이 평면 위에 있다는 것은, 다음 식을 만족하는 $s$, $t$가 존재한다는 뜻입니다.

$$
\vec{p} = \vec{a} + s\vec{u} + t\vec{v} \\\\
s\vec{u} + t\vec{v} = \vec{p} - \vec{a}
$$

두 미지수 $s$와 $t$를 소거하기 위해 양변에 $\vec{u}$와 $\vec{v}$에 동시에 수직인 벡터 $\vec{u} \times \vec{v}$를 내적해보겠습니다. 그러면 좌변은 $0$이 됩니다.

$$ 0 = (\vec{p}-\vec{a}) \cdot (\vec{u} \times \vec{v}) $$

위 식이 성립하면 점 $\vec{p}$는 세 점 $\vec{a}$, $\vec{b}$, $\vec{c}$를 지나는 평면 위에 있다고 할 수 있습니다.

### 선분과 평면의 평행 여부 판정
대상이 되는 평면은 앞서 설명한 평면과 동일하게 식을 잡읍시다.

$$ \vec{a} + s\vec{u} + t\vec{v} \qquad (s \in \mathbb{R},\ t \in \mathbb{R}) $$

임의의 선분에 대해 그 양끝점의 벡터 $\vec{p}$, $\vec{q}$가 주어지면, $\vec{w} = \vec{q} - \vec{p}$에 대해 그 선분 위의 임의의 점은 다음과 같이 쓸 수 있습니다.

$$ \vec{p} + k\vec{w} \qquad (0 \le k \le 1) $$

이 선분과 평면이 평행하다는 것을 식으로 표현하는 방법은 다양하지만, 가장 간단한 방법은 평면에 수직인 벡터가 선분과 수직이라고 하는 것입니다. 평면은 $\vec{u}$와 $\vec{v}$와 평행하므로, 이 둘과 동시에 수직인 벡터와 평면은 수직입니다. 따라서, 평면에 수직인 벡터로 $\vec{u} \times \vec{v}$를 잡을 수 있습니다. 이 벡터가 선분의 방향인 $\vec{w}$와 수직이면 평면과 선분이 평행합니다.

$$ \vec{w} \cdot (\vec{u} \times \vec{v}) = 0 $$

따라서, 위 식이 성립하면 평면과 선분이 평행합니다.

주어진 선분에 대해, 그 위의 아무 점이나 하나 잡았을 때 그 점이 평면 위에 있고, 그 선분이 평면과 평행하면 평면은 선분을 포함합니다. 이 '아무 점'으로는 선분의 양끝점 중 하나를 잡는 게 가장 간단할 겁니다.

정리하면, 두 점 $\vec{p}$와 $\vec{q}$를 양끝점으로 갖는 선분을, 일직선 위에 있지 않은 세 점 $\vec{a}$, $\vec{b}$, $\vec{c}$을 지나는 평면이 포함한다는 것은 다음 조건이 성립하는 것과 동치입니다.

$$ (\vec{p}-\vec{a}) \cdot (\vec{u}\times\vec{v}) = 0 \ ; \quad \vec{w} \cdot (\vec{u} \times \vec{v}) = 0 \qquad (\vec{u} = \vec{b}-\vec{a},\ \vec{v} = \vec{c}-\vec{a},\ \vec{w} = \vec{q} - \vec{p}) $$


## 삼각형과 평면의 교점 계산
다음으로, 삼각형 PQR과 삼각형 T가 주어졌을 때, *삼각형 PQR의 어떠한 변도 평면 a에 포함되지 않는다는 전제가 있을 때* 삼각형 PQR과 평면 a의 교점을 구하고 그게 삼각형 T 내부에 있는지를 판별해봅시다.

삼각형 T의 세 꼭짓점의 위치벡터를 $\vec{a}$, $\vec{b}$, $\vec{c}$라 하면 평면 a 위의 임의의 벡터는 다음과 같이 쓸 수 있습니다. 여기서 $\vec{u} = \vec{b}-\vec{a}$이고 $\vec{v} = \vec{c}-\vec{a}$로, 앞서 쓴 식과 똑같습니다.

$$ \vec{a} + s\vec{u} + t\vec{v} \qquad (s \in \mathbb{R},\ t \in \mathbb{R}) $$

여기서 $s$와 $t$의 범위를 한정하면 삼각형 T 내부의 점만 표현하는 식도 기술할 수 있습니다. 다음과 같습니다.

$$ \vec{a} + s\vec{u} + t\vec{v} \qquad (0 \le s \le 1,\ 0 \le t \le 1,\ s+t \le 1) $$

삼각형 PQR과 평면 a의 교점을 구하는 것은, 선분과 평면의 교점을 구하는 걸 반복하면 알 수 있습니다. 즉, 선분과 평면의 교점을 구하는 법을 알아봅시다.

### 선분과 평면의 교점 계산 및 삼각형 내부 판정
선분의 양끝점을 $\vec{p}$, $\vec{q}$라 하면 그 선분 위의 임의의 점은 다음과 같이 표현할 수 있습니다. 여기서 $\vec{w} = \vec{q} - \vec{p}$입니다.

$$ \vec{p} + k\vec{w} \qquad (0 \le k \le 1) $$

평면과 선분의 교점을 $\vec{x}$라 하면 $\vec{x}$는 다음 식을 만족해야 합니다.

$$ \vec{x} = \vec{a} + s\vec{u} + t\vec{v} = \vec{p} + k\vec{w} \qquad (s \in \mathbb{R},\ t \in \mathbb{R},\ 0 \le k \le 1) $$

즉, 다음 등식을 만족하는 $s$, $t$, $k$가 존재해야 선분과 평면이 교차합니다.

$$ \vec{a} + s\vec{u} + t\vec{v} = \vec{p} + k\vec{w} \qquad (s \in \mathbb{R},\ t \in \mathbb{R},\ 0 \le k \le 1) $$

식을 정리하면 다음과 같습니다. 여기서 $\vec{r} = \vec{p} - \vec{a}$입니다.

$$ s\vec{u} + t\vec{v} - k\vec{w} = \vec{r} \qquad (s \in \mathbb{R},\ t \in \mathbb{R},\ 0 \le k \le 1) $$

각 벡터는 3차원이므로, 위 식은 세 개의 연립방정식이 세 개의 미지수 $s$, $t$, $k$에 대해 세워진 것이라 생각할 수 있습니다. 따라서 위 식에 가우스 소거법을 적용하면 $s$, $t$, $k$가 바로 나옵니다.

...구할 수 있기는 한데, 조금 편한 방법으로 계산해봅시다.

미지수 $t$와 $k$를 동시에 소거하기 위해, 양변에 $\vec{v} \times \vec{w}$를 내적할 수 있습니다. 이 벡터는 $\vec{v}$와 $\vec{w}$에 모두 수직이므로 이렇게 하면 $t$와 $k$가 소거되어 $s$만 남습니다. 마찬가지로 $\vec{w} \times \vec{u}$를 내적하면 $s$와 $k$가 소거되어 $t$만 남고, $\vec{u} \times \vec{v}$를 내적하면 $k$만 남습니다.

$$\begin{aligned}
(\vec{u}\cdot(\vec{v}\times\vec{w}))s &= \vec{r}\cdot(\vec{v}\times\vec{w}) \\\\
(\vec{v}\cdot(\vec{w}\times\vec{u}))t &= \vec{r}\cdot(\vec{w}\times\vec{u}) \\\\
-(\vec{w}\cdot(\vec{u}\times\vec{v}))k &= \vec{r}\cdot(\vec{u}\times\vec{v})
\end{aligned}$$

3차원 벡터의 내적과 외적의 성질에 의해 $\vec{u}\cdot(\vec{v}\times\vec{w}) = \vec{v}\cdot(\vec{w}\times\vec{u}) = \vec{w}\cdot(\vec{u}\times\vec{v})$입니다. 매우 중요한 성질이긴 한데, 증명은 생략하겠습니다. 이 값을 $A$로 두면 위 세 식은 다음과 같이도 쓸 수 있습니다.

$$\begin{aligned}
As &= \vec{r}\cdot(\vec{v}\times\vec{w}) \\\\
At &= \vec{r}\cdot(\vec{w}\times\vec{u}) \\\\
-Ak &= \vec{r}\cdot(\vec{u}\times\vec{v})
\end{aligned}$$

이 식으로 $s$, $t$, $k$를 구할 수 있는지 없는지는 $A=0$인지 아닌지에 달렸습니다.

$A = 0$, 즉 $\vec{w}\cdot(\vec{u}\times\vec{v})=0$은 앞서 확인했던 평면과 선분이 평행할 조건에 해당합니다. 지금 삼각형 PQR의 변이 평면 a에 포함되는 경우를 걸러냈으므로, $A = 0$이면 선분과 평면이 평행하면서 만나지 않는 상황을 의미합니다. 따라서 이 경우는 둘이 교점이 없습니다.

$A \ne 0$이라면, $s$, $t$, $k$의 값은 다음과 같습니다.

$$\begin{aligned}
s &= \frac{\vec{r}\cdot(\vec{v}\times\vec{w})}{A} \\\\
t &= \frac{\vec{r}\cdot(\vec{w}\times\vec{u})}{A} \\\\
k &= -\frac{\vec{r}\cdot(\vec{u}\times\vec{v})}{A}
\end{aligned}$$

이 값을 계산해봤을 때 $0 \le k \le 1$이라면 평면과 선분은 교점을 가지며, 그 교점은 $\vec{p} + k\vec{w}$입니다. 또한, 그와 동시에 $0 \le s \le 1$, $0 \le t \le 1$, $s+t \le 1$이 성립한다면 그 교점은 삼각형 T의 테두리 위 또는 내부에 있습니다. 이 문제에서는 두 삼각형이 교점을 갖는 경우가 없다 했으므로 반드시 내부에 있겠네요.

### 최종
이제 선분과 평면의 교점을 계산할 수 있으므로, 삼각형 PQR과 평면 a의 교점을 전부 계산할 수 있으며, 그 교점이 삼각형 T 내부에 있는지도 판별할 수 있습니다. 이 교점을 전부 계산하여, 삼각형 T 내부에 있는 것들만 골라낸 후, **중복을 제거**했을 때 그 개수가 1개면 두 삼각형은 얽힌 것으로 결론 내릴 수 있습니다.

### TMI: 중복 제거 없이 하는 법
평면과 선분의 교점을 계산할 때, $k$의 허용 범위를 $[0, 1]$이 아닌 $[0, 1)$로 해봅시다. 그러면 이는 평면과 선분의 교점을 계산하되, 그 교점이 선분의 한쪽 끝점 $\vec{q}$면 교점이 없는 것으로 판정하는 셈이 됩니다. 이 판정법을 삼각형 PQR의 세 변에 대해 수행할 때, 세 선분의 양끝점 순서를 PQ, QR, RP로 하면 교점이 중복해서 세어지는 경우가 없습니다. 그러면 교점을 모두 구한 후 중복 제거를 하지 않아도 삼각형과 평면의 교점이 올바르게 계산됩니다.

### TMI: $s$, $t$, $k$의 일반항
사실 마지막에 구한 $s$, $t$, $k$에 대한 세 식은 [Cramer's rule](https://en.wikipedia.org/wiki/Cramer%27s_rule#Explicit_formulas_for_small_systems)과 형태가 동일합니다. Cramer's rule이란 모든 항의 차수가 1인 연립방정식의 일반해를 계산하는 법칙으로, 생긴 게 앞서 쓴 식과 사실상 똑같습니다.

왜 똑같은지 모르겠다고요? $\vec{u} \cdot (\vec{v} \times \vec{w})$의 값은, $\vec{u}$, $\vec{v}$, $\vec{w}$를 각각 세로로 쓴 뒤 가로 방향으로 붙인 행렬의 행렬식과 같습니다. 이걸 두고 보면 위 식은 Cramer's rule과 똑같습니다.